<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.errandsMapper">
	<resultMap type="errandsDTO" id="errandsMap">
		<id column="ERRANDS_NUM" property="errandsNum" />
		<result column="TITLE" property="title" />
		<result column="CONTENT" property="content" />
		<result column="END_TIME" property="endTime" />
		<result column="ARRIVAL_TIME" property="arrivalTime" />
		<result column="FINISH_TIME" property="finishTime" />
		<result column="PRODUCT_PRICE" property="productPrice" />
		<result column="ERRANDS_PRICE" property="errandsPrice" />
		<result column="ERRANDS_PHOTO" property="errandsPhoto" />
		<result column="START_TIME" property="startTime" />
		<association property="requestUser" javaType="memberDTO">
			<id column="REQUEST_ID" property="userId" />
		</association>
		<association property="responseUser" javaType="memberDTO">
			<id column="RESPONSE_ID" property="userId" />
		</association>
		<association property="errandsPos" javaType="ErrandsPosDTO">
			<result column="ADDR" property="addr" />
			<result column="LATITUDE" property="latitude" />
			<result column="LONGITUDE" property="longitude" />
		</association>
		<association property="gpa" javaType="GPADTO">
			<result column="RESPONSE_ACCURACY" property="responseAccuracy" />
			<result column="RESPONSE_SPEED" property="responseSpeed" />
			<result column="RESPONSE_KINDNESS" property="responseKindness" />
			<result column="REQUEST_MANNERS" property="requestManners" />
		</association>
		<collection property="errandsReply" ofType="errandsReplyDTO">
			<id column="ERRANDS_REPLY_NUM" property="replyNum" />
			<result column="REPLY_CONTENT" property="replyContent" />
			<result column="PREDICT_TIME" property="arrivalTime" />
			<result column="REPLY_DATE" property="replyDate" />
			<association property="user" javaType="memberDTO">
				<id column="MEMBER_ID" property="userId" />
				<result column="SELF_IMG" property="selfImg" />
			</association>
		</collection>
	</resultMap>

	<insert id="insertErrands" parameterType="errandsDTO">
		insert into
		ERRANDS(ERRANDS_NUM, TITLE, CONTENT, END_TIME,
		PRODUCT_PRICE,
		ERRANDS_PRICE, ERRANDS_PHOTO, REQUEST_ID)
		values(ERRANDS_NUM.nextval,
		#{title}, #{content}, #{endTime},
		#{productPrice}, #{errandsPrice},
		#{errandsPhoto,jdbcType=VARCHAR}, #{requestUser.userId})
	</insert>
	<select id="selectErrands" parameterType="int" resultMap="errandsMap">
		select * from ERRANDS_REPLY_GPA_VIEW
		<where>
			<if test="value != 0">
				ERRANDS_NUM = #{value}
			</if>
			<if test="value == 0">
				RESPONSE_ID is NULL
			</if>
		</where>
		order by ERRANDS_NUM desc
	</select>

	<select id="selectNum" resultType="int">
		select ERRANDS_NUM.CURRVAL
		from dual
	</select>
	<delete id="deleteErrands" parameterType="int">
		delete from ERRANDS
		where ERRANDS_NUM = #{value}
	</delete>

	<select id="countErrands" resultType="int">
		select count(*) from
		ERRANDS
	</select>

	<select id="searchErrands" resultMap="errandsMap" parameterType="map">
		select * from ERRANDS_REPLY_GPA_VIEW
		<where>
			RESPONSE_ID is null
			<if test="minPrice != null">
				AND ERRANDS_PRICE &gt; #{minPrice}
			</if>
			<if test="maxPrice != null">
				AND ERRANDS_PRICE &lt; #{maxPrice}
			</if>
			<if test="hash != null">
				AND CONTENT like #{hash}
			</if>
			<if test="distance != null">
				AND
				(6371*acos(cos(radians(#{latitude}))*cos(radians(LATITUDE))*cos(radians(LONGITUDE)
				-radians(#{longitude}))+sin(radians(#{latitude}))*sin(radians(LATITUDE))))
				&lt;= #{distance}
			</if>
		</where>
		order by ERRANDS_NUM desc
	</select>

	<select id="myErrandsRequest" parameterType="string" resultMap="errandsMap">
		select * from ERRANDS_REPLY_GPA_VIEW
		<where>
			<if test="value != null">
				REQUEST_ID = #{value}
			</if>
		</where>
		order by RESPONSE_ID, ERRANDS_NUM desc
	</select>

	<select id="countRequest" resultType="int" parameterType="string">
		select count(*) from ERRANDS_REPLY_GPA_VIEW
		<where>
			<if test="value != null">
				REQUEST_ID = #{value}
			</if>
		</where>
	</select>
	<select id="myErrandsResponse" parameterType="string" resultMap="errandsMap">
		select * from ERRANDS_REPLY_GPA_VIEW
		<where>
			<if test="value != null">
				MEMBER_ID = #{value}
			</if>
		</where>
		order by ERRANDS_NUM desc
	</select>
	<select id="countResponse" resultType="int" parameterType="string">
		select count(*) from ERRANDS_REPLY_GPA_VIEW
		<where>
			<if test="value != null">
				MEMBER_ID = #{value}
			</if>
		</where>
	</select>
	<update id="updateErrands" parameterType="map">
		update ERRANDS
		<set>
			<if test="responseId != null">
				RESPONSE_ID = #{responseId},
			</if>
			<if test="arrivalTime != null">
				ARRIVAL_TIME = #{arrivalTime},
			</if>
			<if test="finishTime != null">
				FINISH_TIME = #{finishTime}
			</if>
			<if test="startTime != null">
				START_TIME = to_char(sysdate, 'YYYY-MM-DD HH:MI:SS')
			</if>
		</set>
		where ERRANDS_NUM = #{num}
	</update>
</mapper>