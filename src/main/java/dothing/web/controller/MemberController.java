package dothing.web.controller;

import java.io.File;

import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.ModelAndView;

import dothing.web.dto.MemberDTO;
import dothing.web.service.MemberService;

@Controller
@RequestMapping("/user")
public class MemberController {

	@Autowired
	private MemberService memberService;
	@Autowired
	private PasswordEncoder passwordEncoder;

	/**
	 * 가입 폼
	 */
	@RequestMapping("/signIn")
	public String joinForm() {
		return "/user/signIn";
	}

	/**
	 * 가입하기
	 */

	@RequestMapping("/join")
	public String join(HttpSession session, MemberDTO member, String preAddr, String detailAddr) throws Exception {
		// insert 호출

		MultipartFile selfImgFile = member.getSelfImgFile();
		if (selfImgFile.getSize() == 0 || selfImgFile.getOriginalFilename() == null) {
			throw new Exception("프로필 사진을 첨부해주세요");
		}
		if (preAddr == null || detailAddr == null || preAddr.equals("") || detailAddr.equals("")) {
			throw new Exception("주소란을 확인해주세요.");
		}
		if (member.getName() == null || member.getUserId() == null || member.getPassword() == null
				|| member.getEmail() == null || member.getPhone() == null) {
			throw new Exception("기입하지 않은 정보가 있습니다");
		}
		member.setSelfImg(selfImgFile.getOriginalFilename());
		member.setAddr(preAddr + " " + detailAddr);
		memberService.joinMember(member);
		if (member.getSelfImg() != null && !member.getSelfImg().trim().equals("")) {
			String path = session.getServletContext().getRealPath("") + "\\users\\" + member.getUserId();
			File folder = new File(path);
			folder.mkdirs();
			selfImgFile.transferTo(new File(path + "\\" + member.getSelfImg()));
		}
		return "/main/home";
	}

	/**
	 * 로그인 폼
	 */
	@RequestMapping("/loginForm")
	public String loginForm() {
		return "/user/loginForm";
	}

	/**
	 * ID 중복 체크
	 */
	@RequestMapping("/check")
	public ResponseEntity<String> checkId(String userId) {
		String result = memberService.selectSearch(userId);
		HttpHeaders headers = new HttpHeaders();
		headers.add("Content-type", "text/html;charset=UTF-8");
		ResponseEntity<String> re = new ResponseEntity<String>(result, headers, HttpStatus.OK);

		return re;
	}

	/**
	 * 마이페이지 이동
	 */
	@RequestMapping("/myPage")
	public ModelAndView myPage(Authentication aut) {
		ModelAndView mv = new ModelAndView();
		MemberDTO member = (MemberDTO) aut.getPrincipal();
		mv.addObject("member", member);
		mv.setViewName("/user/myPage");
		return mv;
	}

	@RequestMapping("/update")
	public ModelAndView update(HttpSession session, Authentication aut, MemberDTO updateMember, String currentPassword,
			String newPassword, String renewPassword, String preAddr, String detailAddr) throws Exception {
		ModelAndView mv = new ModelAndView();
		MemberDTO member = (MemberDTO) aut.getPrincipal();
		if (!passwordEncoder.matches(currentPassword, member.getPassword())) {
			throw new Exception("비밀번호가 맞지 않습니다!");
		}
		if (!renewPassword.equals(newPassword)) {
			throw new Exception("새로운 비밀번호를 다시 입력해주세요");
		}
		if (preAddr != null && !preAddr.equals("")) {
			if (detailAddr == null || detailAddr.equals("")) {
				throw new Exception("상세 주소를 입력하세요");
			} else {
				updateMember.setAddr(preAddr + " " + detailAddr);
				member.setAddr(preAddr + " " + detailAddr);
			}
		} else{
			updateMember.setAddr(null);
		}
		
		MultipartFile newProfile = updateMember.getSelfImgFile();
		if ((newProfile.getOriginalFilename() != null && newProfile.getSize() != 0)) {
			updateMember.setSelfImg(newProfile.getOriginalFilename());
			member.setSelfImg(newProfile.getOriginalFilename());
			String path = session.getServletContext().getRealPath("") + "\\users\\" + member.getUserId();
			File folder = new File(path);
			folder.mkdirs();
			newProfile.transferTo(new File(path + "\\" + updateMember.getSelfImg()));
		} else{
			updateMember.setSelfImg(null);
		}
		if (!(newPassword == null || newPassword.equals(""))) {
			updateMember.setPassword(newPassword);
		}
		updateMember.setUserId(member.getUserId());
		memberService.updateMember(updateMember, member);
		mv.setViewName("redirect:/user/myPage");
		return mv;
	}
	

	
	@RequestMapping("/safetyRegister")
	public void safetyRegister(){
	}
	/**
	 * Ajax로 멤버 정보 가져오기
	 */

	@RequestMapping("/selectMember")
	@ResponseBody
	public MemberDTO selectMember(String id){
		return memberService.selectMemberById(id);
	}
}
